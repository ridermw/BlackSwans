name: Sync docs/wiki to GitHub Wiki

on:
  push:
    branches: [main]
    paths:
      - 'docs/wiki/**'
  workflow_dispatch:

concurrency:
  group: wiki-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          token: ${{ secrets.GITHUB_TOKEN }}
          path: wiki-repo

      - name: Sync wiki content
        env:
          REPO: ${{ github.repository }}
        run: |
          # Clear existing wiki content
          rm -f wiki-repo/*.md

          # Copy docs/wiki files with filename transformation
          # Transform snake_case.md -> Title-Case.md
          for file in docs/wiki/*.md; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .md)
              # Transform: split on _, capitalize each word, join with -
              titlecase=$(echo "$basename" | sed 's/_/ /g; s/\b\(.\)/\u\1/g; s/ /-/g')
              cp "$file" "wiki-repo/${titlecase}.md"
            fi
          done

          # Generate Home.md landing page
          {
            echo "# BlackSwans Wiki"
            echo ""
            echo "Validating and extending the analysis from **\"Where the Black Swans Hide & The 10 Best Days Myth\"** by Mebane Faber (2011)."
            echo ""
            echo "| Page | Description |"
            echo "|------|-------------|"
            echo "| [Architecture](Architecture) | Package structure, data pipeline, and module design |"
            echo "| [Data Dictionary](Data-Dictionary) | Data sources, schemas, and field definitions |"
            echo "| [Analysis Methods](Analysis-Methods) | Statistical tests and analytical methodology |"
            echo "| [Changelog](Changelog) | Version history and notable changes |"
            echo ""
            echo "---"
            echo "*This wiki is auto-generated from [\`docs/wiki/\`](https://github.com/${REPO}/tree/main/docs/wiki). Edit the source files there, not here.*"
          } > wiki-repo/Home.md

      - name: Commit and push changes
        working-directory: wiki-repo
        env:
          SHORT_SHA: ${{ github.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes to commit"
          else
            git commit -m "Sync wiki from docs/wiki/ (${SHORT_SHA::7})"
            git push
          fi
